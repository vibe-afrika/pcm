input {
  tcp {
    port => 5044
    codec => json_lines
  }
}

filter {
  # Parse JSON if not already parsed
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add service metadata
  mutate {
    add_field => {
      "[@metadata][index_prefix]" => "pcm-logs"
    }
  }

  # Extract trace context if present
  if [traceId] {
    mutate {
      add_field => { "trace.id" => "%{traceId}" }
    }
  }
  if [spanId] {
    mutate {
      add_field => { "span.id" => "%{spanId}" }
    }
  }

  # Extract tenant context
  if [tenantId] {
    mutate {
      add_field => { "tenant.id" => "%{tenantId}" }
    }
  }

  # Ensure timestamp field
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # Add environment tag
  mutate {
    add_field => { "environment" => "${ENVIRONMENT:development}" }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Debug output for development
  stdout {
    codec => rubydebug
  }
}
